# Гем для работы с webpay.by

Гем для работы с платежной системой WebPay для использования в проектах на Ruby (Ruby On Rails, Sinatra и др.).

WebPay («Вебпей») – белорусская система электронных платежей компании ООО «ВЭБ ПЭЙ», для осуществления безопасных
платежей при помощи банковских карт VISA и MasterCard в режиме реального времени в любой валюте (BYN, USD, RUB, EUR
и т.д.).

WebPay Sandbox — самостоятельное Web-приложение, являющееся прототипом реальной системы, и предназначенное для
тестированияи и ознакомления с возможностями реальной системы WebPay.

Официальный сайт: https://webpay.by

Документация: https://webpay.by/wp-content/uploads/2016/08/WebPay-Developer-Guide-2.1.2_RU.pdf

Текущая версия гема работает с протоколом версии 2.1.2. 


## Установка

Добавьте эту строку в ваш Gemfile:

    gem 'webpay_by'

Затем установите gem, используя bundler:

    $ bundle

Или выполните команду:

    $ gem install webpay_by


## Использование (примеры с использованием Ruby On Rails)

### Шаги

WebPay осуществляет оплату следущим образом:

1. На стороне приложения формируется заказ, которому присваивается уникальный номер
1. На стороне приложения формируется HTML-форма, в полях которой закодированы детали заказа: номер, сумма, и проч.,
а также криптографическая подпись. Адрес формы указывает на сервер WebPay
1. Клиент (плательщик) отправляет форму, таким образом переходя на сайт WebPay
1. После окончания (или отмены, провала) платежа клиент возвращается на указанный в форме УРЛ `back_url`; это только для
удобства клиента, полагаться на этот переход нельзя (он может просто закрыть браузер)
1. В случае успешной оплаты, сервер WebPay посылает отдельный подписанный POST-запрос на другой УРЛ, что был указан
в форме (`notify_url`)
1. Обработчик на стороне приложения валидирует этот запрос, и если все ок, выполняет действия, связанные с заказом
1. Поскольку при платеже сумма только блокируется, ее нужно реально списать. Для этого, после предыдущего шага, по сети
отправляется новый подписанный запрос на сервер WebPay с командой списать в нашу пользу заблокированную сумму. Если
автоподтверждение не требуется, этот шаг можно пропустить и сделать вручную в личном кабинете WebPay

### Перед началом работы

Заключите договор с WebPay и получите доступ в личный кабинет, а также комплект ключей для использования в геме.

### Настройка

Создаем клиент для работы с WebPay

```ruby
webpay_client = WebpayBy::Client.new(
  secret_key: 'your_secret_key',
  billing_id: '000000001',
  debug_mode: !Rails.env.production?,
  login:      'your_login',
  password:   'your_password'
)
```

Формируем заказ, запрос на оплату и создаем форму

```ruby
# заказ в нашей системе
order = ... # Order.new ...

# запрос к WebPay; нигде не сохраняется, объект нужен только для создания формы 
request = webpay_client.request(
  order_id:   order.id,
  seed:       Time.now,
  back_url:   webpay_back_url,
  notify_url: webpay_notify_url,
  items:      [{price: order.price, name: 'Пополнение счёта', quantity: 1}]
)

# форма, содержащая данные запроса
@form = request.form
```

Во вьюхе с помощью объекта формы строим ее HTML

```slim
= form_tag @form.action_url, method: @form.request_method, enctype: @form.enctype do
  - @form.fields.each do |key, value|
    = hidden_field_tag key, value
  = submit_tag 'Перейти к пополнению'
```

Важно: 
- В режиме разработки, после отправки формы оплаты, сервер WebPay может не принять запрос, ссылаясь на неправильный формат
wsb_notify_url или wsb_return_url. Это связано с тем, что система валидирует эти поля как реальные домены. `localhost,
*.dev, *.localhost` и т.д работать не будут. Поэтому, перед созданием формы, передайте в запрос параметры notify_url
и back_url c валидными адресами
- Если у вас в биллинг-аккаунте подключена возможность приема оплаты и через систему ЕРИП, то при тестировании платежей
максимальная длина имени счета (wsb_order_num) равна 10 символам. В реальной среде размер этого поля может измениться
в зависимости от ограничений, которые будут установлены системой ЕРИП

После совершения удачного платежа, система WebPay отсылает специально сформированный POST-запрос по адресу, указанному
в поле wsb_notify_url Интернет-ресурса (поле заказа notify_url). В этом запросе содержится информация по платежу.
Полученную информацию сторона приложения должна проверить в соответствии с требованиями выполнения заказа и ответить
на запрос кодом HTTP 200.

```ruby
answer_hash = params.except(:controller, :action).to_unsafe_h.symbolize_keys
response    = webpay_client.response answer_hash

if response.approved?
  order = ... # Order.find response.site_order_id
  raise '...' if !order || response.amount != order.amount
  do_money_stuff order
end 

render nothing: true, status: 200
``` 

Что такое "подтверждение": когда человек ввел данные карты, нужная сумма только блокируется на ней, о чем нам и сообщает
упомянутый выше POST-запрос. Чтобы она реально списалась, мы должны сообщить системе WebPay, что услуга оказана
и сумму можно списать.

Если подтверждение нужно делать автоматически, через cron или аналог надо запускать робота, который будет выбирать
оплаченные заказы и их подтверждать.

```ruby
last_payed_order      = ... # Order.where(payed: true, confirmed: false).order_by(date: :asc).limit(1).first
confirmation          = webpay_client.confirmation transaction_id: last_payed_order.transaction_id
confirmation_response = confirmation.send

# проверяем ответ от системы на подлинность и верность
last_payed_order.update confirmed: true if confirmation_response.approved?
```
