# Гем для работы с webpay.by

Гем для работы с платежной системой WebPay для использования в проектах на Ruby (Ruby On Rails, Sinatra и др.).

WebPay («Вебпей») – белорусская система электронных платежей компании ООО «ВЭБ ПЭЙ», для осуществления безопасных
платежей при помощи банковских карт VISA и MasterCard в режиме реального времени в любой валюте (BYN, USD, RUB, EUR
и т.д.).

WebPay Sandbox — самостоятельное Web-приложение, являющееся прототипом реальной системы, и предназначенное для  
тестирования и ознакомления с возможностями реальной системы WebPay.

Официальный сайт: https://webpay.by

Документация: https://webpay.by/wp-content/uploads/2016/08/WebPay-Developer-Guide-2.1.2_RU.pdf

Текущая версия гема работает с протоколом версии 2.1.2. 


## Установка

Добавьте эту строку в ваш Gemfile:

    gem 'webpay_by'

Затем установите gem, используя bundler:

    $ bundle

Или выполните команду:

    $ gem install webpay_by


## Использование (примеры с использованием Ruby On Rails)

### Шаги

WebPay осуществляет оплату следущим образом:

1. На стороне приложения формируется заказ, которому присваивается уникальный номер
1. На стороне приложения формируется HTTP-форма, в полях которой закодированы детали заказа: номер, сумма, и проч.,
а также криптографическая подпись. Адрес формы указываем на сервер WebPay
1. Клиент (плательщик) отправляет форму, таким образом переходя на сайт WebPay
1. После окончания (или отмены, провала) платежа клиент возвращается на указанный в форме УРЛ; это
1. В случае успешной оплаты, сервер WebPay отдельным запросом посылает подписанный запрос на УРЛ, что был указан в форме
1. Обработчик на стороне приложения валидирует этот запрос, и если все ок, выполняет действия, связанные с заказом
1. Поскольку при платеже сумма только блокируется, ее нужно реально списать. Для этого, после предыдущего шага по сети
отправляется новый подписанный запрос на сервер WebPay с командой списать в нашу пользу заблокированную сумму

### Перед началом работы

Заключите договор с WebPay и получите доступ в личный кабинет, а также комплект ключей для использования в геме.

### Настройка

Создаем клиент для работы с WebPay

```ruby
require 'webpay_by/client'

webpay_client = WebpayBy::Client.new(
  secret_key: 'your_secret_key',
  billing_id: '000000001',
  debug_mode: !Rails.env.production?,
  login:      'your_login',
  password:   'your_password'
)
```

Формируем заказ и создаем форму

```ruby
request = webpay_client.request(
  order_id:   'item-1',
  seed:       Time.now,
  back_url:   product_url,
  notify_url: webpay_notify_url,
  items:      [{price: 100, name: 'Пополнение счёта', quantity: 1}]
)

@form = request.form
```

Во вьюхе с помощью объекта формы строим ее HTML

```slim
= form_tag @form.action_url, method: @form.request_method, enctype: @form.enctype do
  - @form.fields.each do |key, value|
    = hidden_field_tag key, value
  = submit_tag 'Перейти к пополнению'
```

Важно: 
- В режиме разработки, после подтверждения формы оплаты, система может не принять запрос, ссылаясь на неправильный формат
wsb_notify_url или wsb_return_url. Это связано с тем, что система валидирует эти поля как реальные домены. localhost,
*.dev, *.localhost и т.д работать не будут. Поэтому перед созданием формы передайте в заказ параметры notify_url
и back_url c валидными адресами
- Если у вас в биллинг-аккаунте подключена возможность приема оплаты и через систему ЕРИП, то при тестировании платежей
максимальная длина имени счета (wsb_order_num) равна 10 символам. В реальной среде размер этого поля может измениться
в зависимости от ограничений, которые будут установлены системой ЕРИП

После совершения удачного платежа, система WebPay отсылает специально сформированный POST-запрос по адресу, указанному
в поле wsb_notify_url Интернет-ресурса. В этом запросе содержится информация по платежу. Полученную информацию
сторона приложения должна проверить в соответствии с требованиями выполнения заказа и ответить на запрос кодом HTTP 200.

```ruby
answer_hash = params.except(:controller, :action).to_unsafe_h.symbolize_keys
response    = webpay_client.response answer_hash

if response.approved?
  order = Order.find response.order_id
  raise '...' if !order || response.amount != order.amount
  do_money_stuff order
end 

render nothing: true, status: 200
``` 

Прежде чем доставить товар (оказать услугу), Интернет-ресурс обязан проверить совершенный покупателем платеж.

Что такое "подтверждение": когда человек ввел данные карты, нужная сумма только блокируется на ней. Чтобы она
реально списалась, мы должны сообщить системе WebPay, что услуга оказана и сумму можно списать. Это и есть подтверждение.
Его нужно делать автоматически, поэтому через cron или аналог надо запускать робота, который будет выбирать
оплаченные заказы и их подтверждать.

```ruby
last_payed_order      = ... # Order.where(payed: true, confirmed: false).order_by(date: :asc).limit(1).first
confirmation          = webpay_client.confirmation transaction_id: last_payed_order.transaction_id
confirmation_response = confirmation.send

# Проверяем ответ от системы на подлинность электронной подписи и подтверждения об оплате
last_payed_order.update confirmed: true if confirmation_response.approved?
```
